#!/bin/bash
# build-debian-iso-nonlive.sh
# Creates a bootable non-live Debian ISO (minimal system)

set -e

# ========================
# Configuration
# ========================
DEBIAN_RELEASE="bookworm"
ARCH="amd64"
TARGET_DIR="./debian-root"
ISO_DIR="./iso"
ISO_NAME="mydebian-nonlive.iso"
MIRROR="http://deb.debian.org/debian"
HOSTNAME="mydebian"
USERNAME="user"

# ========================
# Install required packages
# ========================
sudo apt update
sudo apt install -y debootstrap grub-pc-bin grub-efi-amd64-bin xorriso mtools

# ========================
# Step 1: Bootstrap minimal Debian
# ========================
sudo rm -rf "$TARGET_DIR"
sudo debootstrap --arch="$ARCH" "$DEBIAN_RELEASE" "$TARGET_DIR" "$MIRROR"

# ========================
# Step 2: Configure minimal system
# ========================
sudo chroot "$TARGET_DIR" /bin/bash -c "
echo '$HOSTNAME' > /etc/hostname
echo '127.0.0.1 localhost' > /etc/hosts

apt update
apt install -y sudo vim bash-completion net-tools ifupdown iproute2 \
    systemd-sysv linux-image-amd64 grub-pc

# Create user
useradd -m -s /bin/bash $USERNAME
echo '$USERNAME:password' | chpasswd
usermod -aG sudo $USERNAME

# Install GRUB to /boot
grub-install --target=i386-pc --boot-directory=/boot /dev/sda || true
"

# ========================
# Step 3: Setup fstab
# ========================
cat << EOF | sudo tee "$TARGET_DIR/etc/fstab"
/dev/sda1    /        ext4    errors=remount-ro 0 1
proc         /proc    proc    defaults 0 0
sysfs        /sys     sysfs   defaults 0 0
devpts       /dev/pts devpts  defaults 0 0
tmpfs        /tmp     tmpfs   defaults 0 0
EOF

# ========================
# Step 4: Prepare ISO directory
# ========================
sudo rm -rf "$ISO_DIR"
sudo mkdir -p "$ISO_DIR/boot/grub"
sudo cp -r "$TARGET_DIR/boot" "$ISO_DIR/"

# ========================
# Step 5: Create GRUB configuration
# ========================
cat << EOF | sudo tee "$ISO_DIR/boot/grub/grub.cfg"
set default=0
set timeout=5

menuentry "My Debian Minimal" {
    linux /boot/vmlinuz root=/dev/sda1 rw
    initrd /boot/initrd.img
}
EOF

# ========================
# Step 6: Create bootable ISO
# ========================
sudo grub-mkrescue -o "$ISO_NAME" "$ISO_DIR"

echo "âœ… Bootable non-live ISO created: $ISO_NAME"
echo "You can now install it on a physical disk or virtual machine."
